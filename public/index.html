<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Platinum Elite P2P</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #0a0a0a; color: #f39c12; font-family: sans-serif; margin: 0; }
        .container { max-width: 800px; margin: auto; padding: 20px; }
        .card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        input { background: #222; color: white; border: 1px solid #444; padding: 10px; border-radius: 4px; margin: 5px; }
        button { background: #f39c12; color: black; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        #chat-box { height: 200px; overflow-y: auto; background: black; border: 1px solid #333; padding: 15px; margin: 10px 0; color: #0f0; text-align: left; font-family: monospace; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #222; padding: 12px; text-align: center; color: white; }
        th { color: #f39c12; }
    </style>
</head>
<body>
    <div id="login-screen" class="container">
        <div class="card">
            <h2>PLATINUM ACCESS</h2>
            <input type="text" id="user_in" placeholder="Usuario" style="width: 200px;">
            <input type="password" id="pass_in" placeholder="Contrase帽a" style="width: 200px;">
            <br><br>
            <button onclick="auth()">ENTRAR AL SISTEMA</button>
        </div>
    </div>

    <div id="main-screen" class="container hidden">
        <div style="display:flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f39c12; padding-bottom: 10px;">
            <h3>BIENVENIDO: <span id="display-user"></span></h3>
            <h3>SALDO: <span id="display-saldo"></span> USDT</h3>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h4>Publicar Venta de USDT</h4>
            <input type="number" id="v-monto" placeholder="Monto USDT">
            <input type="number" id="v-precio" placeholder="Precio Bs">
            <button onclick="crearOrden()">PUBLICAR ANUNCIO</button>
        </div>

        <div class="card">
            <h4>Mercado P2P Activo</h4>
            <table>
                <thead><tr><th>Vendedor ID</th><th>Monto</th><th>Precio</th><th>Acci贸n</th></tr></thead>
                <tbody id="lista-ordenes"></tbody>
            </table>
        </div>

        <div id="chat-p2p" class="card hidden">
            <h4 style="color: #27ae60;">SALA DE NEGOCIACIN PRIVADA #<span id="orden-activa"></span></h4>
            <div id="chat-box"></div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="msg-input" placeholder="Escribe un mensaje..." style="flex-grow: 1;">
                <button onclick="enviarMsg()">ENVIAR</button>
            </div>
            <hr style="border: 0.5px solid #333; margin: 20px 0;">
            <button onclick="confirmarLiberacion()" style="background: #27ae60; color: white; width: 100%; height: 50px; font-size: 1.1em;">
                锔 LIBERAR USDT (PAGO RECIBIDO)
            </button>
        </div>
    </div>

<script>
    const socket = io();
    let me = null;
    let ordenActual = {};

    // 1. Autenticaci贸n
    async function auth() {
        const res = await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ usuario: user_in.value, clave: pass_in.value })
        });
        if (res.ok) {
            me = await res.json();
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            document.getElementById('display-user').innerText = me.usuario;
            document.getElementById('display-saldo').innerText = me.saldo;
            cargarOrdenes();
        } else { alert("Error: Credenciales inv谩lidas"); }
    }

    // 2. Cargar Mercado
    async function cargarOrdenes() {
        const res = await fetch('/ordenes');
        const ordenes = await res.json();
        document.getElementById('lista-ordenes').innerHTML = ordenes.map(o => `
            <tr>
                <td>ID: ${o.vendedor_id}</td>
                <td>${o.monto_usdt} USDT</td>
                <td>${o.monto_bs} Bs</td>
                <td><button onclick="abrirChat(${o.id}, ${o.monto_usdt}, ${o.vendedor_id})">COMPRAR / CHAT</button></td>
            </tr>
        `).join('');
    }

    // 3. Crear Anuncio
    async function crearOrden() {
        const res = await fetch('/crear-orden', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ seller_id: me.id, amount: v_monto.value, price: v_precio.value })
        });
        if(res.ok) { 
            alert("隆Anuncio publicado con 茅xito!"); 
            v_monto.value = ""; v_precio.value = "";
            cargarOrdenes(); 
        }
    }

    // 4. Chat Sockets
    function abrirChat(id, monto, vendedor) {
        ordenActual = { id, monto, vendedor };
        document.getElementById('chat-p2p').classList.remove('hidden');
        document.getElementById('orden-activa').innerText = id;
        document.getElementById('chat-box').innerHTML = "<p style='color:gray italic'>Conexi贸n cifrada establecida...</p>";
        socket.emit('unirse_p2p', id);
        window.scrollTo(0, document.body.scrollHeight);
    }

    function enviarMsg() {
        const input = document.getElementById('msg-input');
        if (!input.value) return;
        socket.emit('msg_p2p', { ordenId: ordenActual.id, user: me.usuario, msg: input.value });
        input.value = "";
    }

    socket.on('update_chat', (data) => {
        const box = document.getElementById('chat-box');
        box.innerHTML += `<p><strong>${data.user}:</strong> ${data.msg}</p>`;
        box.scrollTop = box.scrollHeight;
    });

    // 5. Liberar Fondos (Finalizar P2P)
    async function confirmarLiberacion() {
        if(!confirm("驴CONFIRMAS LA LIBERACIN? Los USDT se mover谩n a la cuenta del comprador de forma irreversible.")) return;
        
        const res = await fetch('/liberar-fondos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                ordenId: ordenActual.id, 
                vendedorId: ordenActual.vendedor, 
                compradorId: me.id, 
                monto: ordenActual.monto 
            })
        });

        if(res.ok) { 
            alert(" 隆TRANSACCIN EXITOSA! USDT Enviados."); 
            location.reload(); 
        } else {
            alert("Error en la liberaci贸n. Verifica tu saldo o conexi贸n.");
        }
    }
</script>
</body>
</html>
EOF
